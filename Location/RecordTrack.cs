using Android.App;
using Android.Content;
using Android.OS;
using Android.Runtime;
using Android.Views;
using Android.Widget;
using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using System.Linq;
using System.Text;
using SharpGPX;
using SharpGPX.GPX1_0;
using SharpGPX.GPX1_1;
using Xamarin.Essentials;
using hajk.Data;
using System.Threading;
using Serilog;
using Mapsui.Layers;

namespace hajk
{
    class RecordTrack
    {
        public static GpxClass trackGpx = new GpxClass();
        private static Timer Order_Timer;

        public static void StartTrackTimer()
        {
            MainActivity.RecordingTrack = true;
            /**///Move to a proper thread?
            Order_Timer = new Timer(new TimerCallback(GetGPSLocationEvent), null, 0, MainActivity.freq_s * 1000);
        }

        public static void SaveTrack()
        {
            Order_Timer.Dispose();

            string name = DateTime.Now.ToString("dd/MM/yyyy HH:mm");

            GpxClass track = new GpxClass()
            {
                Metadata = new metadataType()
                {
                    author = new personType("hajk"),
                    link = new linkTypeCollection().AddLink(new linkType("https://www.github.com/johnjore/hajk", "John's software")),
                    /**///This should reflect the name of the route we're following, or a user selected name
                    name = name,
                    desc = "Track generated by hajk",
                    copyright = new copyrightType("hajk", "2021"),
                    //< email />
                    //< license />
                    //version = "1.1"
                },
            };

            track.Tracks.Add(new trkType()
            {
                name = name,
                trkseg = new trksegTypeCollection().AddItem(
                    new trksegType()
                    {
                        trkpt = trackGpx.Waypoints
                    })
            });

            track.Metadata.bounds = track.GetBounds();

            string trackPath = Path.Combine(Android.OS.Environment.GetExternalStoragePublicDirectory(Android.OS.Environment.DirectoryDownloads).AbsolutePath, "JJTesting.gpx");
            track.ToFile(trackPath);

            MainActivity.RecordingTrack = false;
        }

        private static void GetGPSLocationEvent(object state)
        {
            var location = Geolocation.GetLastKnownLocationAsync().Result;
            Log.Information($"Updated GPS Location - {location.Timestamp} - Altitude: {location.Altitude}, Lat: {location.Latitude}, Lon: {location.Longitude}, Speed: {location.Speed}");

            wptType waypoint = new wptType()
            {
                lat = (decimal)location.Latitude,
                lon = (decimal)location.Longitude,
                ele = (decimal)location.Altitude,
                time = DateTime.Now,
                timeSpecified = true,
            };

            trackGpx.Waypoints.Add(waypoint);

            Log.Information($"Got {trackGpx.Waypoints.Count} waypoints");

            if (MainActivity.DrawTrackOnGui)
                DrawTrackOnGui();
        }

        private static void DrawTrackOnGui()
        {
            /**///There must be a better way to update the track than delete and re-create the layer. Can't we just append additional waypoints to the linestring

            string mapTrack = "LINESTRING(";

            for (int i = 0; i < trackGpx.Waypoints.Count; i++)
            {
                //WayPoint
                if (!(mapTrack.Equals("LINESTRING(")))
                {
                    mapTrack += ",";
                }
                mapTrack += trackGpx.Waypoints[i].lat.ToString() + " " + trackGpx.Waypoints[i].lon.ToString();
            }
            mapTrack += ")";

            //Add to map as a layer
            ILayer lineStringLayer = Import.CreateTrackLayer(mapTrack, Import.CreateTrackStyle());
            foreach (ILayer layer in MainActivity.map.Layers.FindLayer("TrackLayer"))
            {
                MainActivity.map.Layers.Remove(layer);
            }            
            MainActivity.map.Layers.Add(lineStringLayer);

            Log.Information($"Got {MainActivity.map.Layers.Count} layers");
        }
    }
}
